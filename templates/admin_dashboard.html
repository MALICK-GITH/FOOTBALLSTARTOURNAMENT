{% extends "base.html" %}

{% block title %}Dashboard Admin - eFootKings 2026 üá®üáÆ{% endblock %}

{% block content %}
<section class="admin-dashboard py-5 mt-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-white fw-bold mb-3">
                    <i class="fas fa-cog me-2 text-warning"></i>Dashboard Administrateur
                </h1>
                <div class="stats-row mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="stat-card card-custom p-3 text-center">
                                <i class="fas fa-users fa-2x text-warning mb-2"></i>
                                <h3 class="text-white mb-0">{{ players|length }}</h3>
                                <small class="text-white-50">Total inscriptions</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card card-custom p-3 text-center">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h3 class="text-white mb-0">{{ validated_players|length }}</h3>
                                <small class="text-white-50">Joueurs valid√©s</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card card-custom p-3 text-center">
                                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                <h3 class="text-white mb-0">{{ pending_count }}</h3>
                                <small class="text-white-50">En attente</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card card-custom p-3 text-center">
                                <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                                <h3 class="text-white mb-0">8</h3>
                                <small class="text-white-50">Limite max</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button">
                    <i class="fas fa-users me-2"></i>Joueurs inscrits
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket" type="button">
                    <i class="fas fa-sitemap me-2"></i>G√©rer le bracket
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button">
                    <i class="fas fa-envelope me-2"></i>Messagerie
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <!-- Onglet Joueurs -->
            <div class="tab-pane fade show active" id="players" role="tabpanel">
                <div class="card-custom p-4">
                    <h3 class="text-warning mb-4">
                        <i class="fas fa-list me-2"></i>Liste des joueurs
                    </h3>
                    
                    {% if players %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Pseudo</th>
                                    <th>Contact</th>
                                    <th>Date inscription</th>
                                    <th>Paiement</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in players %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if player.profile_picture %}
                                            <img src="{{ url_for('uploaded_file', filename=player.profile_picture) }}" 
                                                 alt="Photo" 
                                                 class="rounded-circle me-2" 
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                            <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center me-2" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold">{{ player.pseudo }}</div>
                                                {% if player.full_name %}
                                                <small class="text-white-50">{{ player.full_name }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ player.contact or '-' }}
                                        {% if player.is_online %}
                                        <span class="badge bg-success ms-2" title="En ligne">
                                            <i class="fas fa-circle" style="font-size: 8px;"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ player.registered_at.strftime('%d/%m/%Y') if player.registered_at else '-' }}</small>
                                    </td>
                                    <td>
                                        {% if player.payment_screenshot %}
                                        <a href="{{ url_for('uploaded_file', filename=player.payment_screenshot) }}" 
                                           target="_blank" 
                                           class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-image me-1"></i>Voir
                                        </a>
                                        {% else %}
                                        <span class="text-danger">Aucun</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if player.status == 'validated' %}
                                        <span class="badge bg-success">Valid√©</span>
                                        {% elif player.status == 'rejected' %}
                                        <span class="badge bg-danger">Refus√©</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">En attente</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if player.status != 'validated' %}
                                        <button class="btn btn-sm btn-success validate-btn" 
                                                data-player-id="{{ player.id }}"
                                                {% if validated_players|length >= 8 %}disabled title="Tournoi complet"{% endif %}>
                                            <i class="fas fa-check me-1"></i>Valider
                                        </button>
                                        {% endif %}
                                        {% if player.status != 'rejected' %}
                                        <button class="btn btn-sm btn-danger reject-btn" 
                                                data-player-id="{{ player.id }}">
                                            <i class="fas fa-times me-1"></i>Refuser
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-btn" 
                                                data-player-id="{{ player.id }}"
                                                title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-white-50 text-center">Aucun joueur inscrit pour le moment.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Onglet Bracket -->
            <div class="tab-pane fade" id="bracket" role="tabpanel">
                <div class="card-custom p-4">
                    <h3 class="text-warning mb-4">
                        <i class="fas fa-sitemap me-2"></i>Gestion du bracket
                    </h3>
                    
                    {% if validated_players|length < 8 %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Le bracket sera disponible une fois que 8 joueurs auront √©t√© valid√©s.
                        Actuellement : <strong>{{ validated_players|length }} / 8</strong>
                    </div>
                    {% elif bracket.quarterfinals %}
                    <!-- Quarts de finale -->
                    <div class="bracket-admin mb-5">
                        <h4 class="text-white mb-3">Quarts de finale</h4>
                        <div class="row g-3">
                            {% for match in bracket.quarterfinals %}
                            <div class="col-md-6">
                                <div class="match-admin-card card-custom p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-white fw-bold">{{ match.player1 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-sm score-input" 
                                               data-round="quarterfinals"
                                               data-match-index="{{ loop.index0 }}"
                                               data-player="1"
                                               value="{{ match.score1 }}"
                                               min="0"
                                               style="width: 80px; display: inline-block;">
                                    </div>
                                    <div class="text-center text-white-50 mb-2">VS</div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-white fw-bold">{{ match.player2 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-sm score-input" 
                                               data-round="quarterfinals"
                                               data-match-index="{{ loop.index0 }}"
                                               data-player="2"
                                               value="{{ match.score2 }}"
                                               min="0"
                                               style="width: 80px; display: inline-block;">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Demi-finales -->
                    {% if bracket.semifinals %}
                    <div class="bracket-admin mb-5">
                        <h4 class="text-white mb-3">Demi-finales</h4>
                        <div class="row g-3">
                            {% for match in bracket.semifinals %}
                            <div class="col-md-6">
                                <div class="match-admin-card card-custom p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-white fw-bold">{{ match.player1 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-sm score-input" 
                                               data-round="semifinals"
                                               data-match-index="{{ loop.index0 }}"
                                               data-player="1"
                                               value="{{ match.score1 }}"
                                               min="0"
                                               style="width: 80px; display: inline-block;">
                                    </div>
                                    <div class="text-center text-white-50 mb-2">VS</div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-white fw-bold">{{ match.player2 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-sm score-input" 
                                               data-round="semifinals"
                                               data-match-index="{{ loop.index0 }}"
                                               data-player="2"
                                               value="{{ match.score2 }}"
                                               min="0"
                                               style="width: 80px; display: inline-block;">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Finale -->
                    {% if bracket.final %}
                    <div class="bracket-admin mb-5">
                        <h4 class="text-white mb-3">Finale</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="match-admin-card card-custom p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-white fw-bold fs-5">{{ bracket.final.player1 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-lg score-input" 
                                               data-round="final"
                                               data-match-index="0"
                                               data-player="1"
                                               value="{{ bracket.final.score1 }}"
                                               min="0"
                                               style="width: 100px; display: inline-block;">
                                    </div>
                                    <div class="text-center text-white-50 mb-3 fs-4">VS</div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-white fw-bold fs-5">{{ bracket.final.player2 }}</span>
                                        <input type="number" 
                                               class="form-control form-control-lg score-input" 
                                               data-round="final"
                                               data-match-index="0"
                                               data-player="2"
                                               value="{{ bracket.final.score2 }}"
                                               min="0"
                                               style="width: 100px; display: inline-block;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="text-center mt-4">
                        <button id="saveBracketBtn" class="btn btn-warning btn-lg">
                            <i class="fas fa-save me-2"></i>Enregistrer les scores
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Onglet Messagerie -->
            <div class="tab-pane fade" id="messages" role="tabpanel">
                <div class="card-custom p-4">
                    <div class="text-center mb-4">
                        <a href="{{ url_for('admin_messages') }}" class="btn btn-warning btn-lg">
                            <i class="fas fa-envelope me-2"></i>G√©rer les messages
                        </a>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Utilisez la messagerie pour envoyer des annonces, r√©sultats, nouvelles fonctionnalit√©s, etc.
                        Les messages peuvent √™tre globaux (tous les utilisateurs) ou cibl√©s (un utilisateur sp√©cifique).
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // Validation/Rejet des joueurs
    document.querySelectorAll('.validate-btn, .reject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const playerId = this.dataset.playerId;
            const action = this.classList.contains('validate-btn') ? 'validate' : 'reject';
            
            fetch(`/admin/validate/${playerId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Erreur lors de la validation');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de la requ√™te');
            });
        });
    });

    // Suppression des joueurs
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const playerId = this.dataset.playerId;
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ? Cette action est irr√©versible.')) {
                fetch(`/admin/delete-user/${playerId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de la requ√™te');
                });
            }
        });
    });

    // Sauvegarde du bracket
    document.getElementById('saveBracketBtn')?.addEventListener('click', function() {
        const bracketData = {
            quarterfinals: [],
            semifinals: [],
            final: null
        };

        // R√©cup√©rer les scores des quarts de finale
        document.querySelectorAll('[data-round="quarterfinals"]').forEach(input => {
            const matchIndex = parseInt(input.dataset.matchIndex);
            const player = input.dataset.player;
            const score = parseInt(input.value) || 0;
            
            if (!bracketData.quarterfinals[matchIndex]) {
                bracketData.quarterfinals[matchIndex] = {
                    player1: '',
                    player2: '',
                    score1: 0,
                    score2: 0
                };
            }
            
            if (player === '1') {
                bracketData.quarterfinals[matchIndex].score1 = score;
            } else {
                bracketData.quarterfinals[matchIndex].score2 = score;
            }
        });

        // R√©cup√©rer les scores des demi-finales
        document.querySelectorAll('[data-round="semifinals"]').forEach(input => {
            const matchIndex = parseInt(input.dataset.matchIndex);
            const player = input.dataset.player;
            const score = parseInt(input.value) || 0;
            
            if (!bracketData.semifinals[matchIndex]) {
                bracketData.semifinals[matchIndex] = {
                    player1: '',
                    player2: '',
                    score1: 0,
                    score2: 0
                };
            }
            
            if (player === '1') {
                bracketData.semifinals[matchIndex].score1 = score;
            } else {
                bracketData.semifinals[matchIndex].score2 = score;
            }
        });

        // R√©cup√©rer les scores de la finale
        const finalInputs = document.querySelectorAll('[data-round="final"]');
        if (finalInputs.length > 0) {
            bracketData.final = {
                player1: '',
                player2: '',
                score1: parseInt(finalInputs[0].value) || 0,
                score2: parseInt(finalInputs[1].value) || 0
            };
        }

        // Envoyer les donn√©es
        fetch('/admin/update-bracket', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bracketData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Scores enregistr√©s avec succ√®s !');
                location.reload();
            } else {
                alert('Erreur lors de l\'enregistrement');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la requ√™te');
        });
    });
</script>
{% endblock %}

